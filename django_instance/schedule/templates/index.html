{% load static %}
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Schedule App</title>

        <link href={% static "styles.css"%} rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script type="module" src={% static "listeners.js"%}></script>
        <script type="module" src={% static "tasks.js"%}></script>
        <script type="module" src={% static "xml_requests.js"%}></script>
    </head>
    <body  class="background">
    <div x-data="{projects: []}" @restart  = "projects = await (await fetch('/api/projects/')).json()">
        <div  id="main"
            x-init="projects = await (await fetch('/api/projects/')).json()"
        >
        <template x-for="project in projects">
            <div class="my-5 container px-0"
                x-data="{  key: 0, tasks: [] }"
                x-init="tasks = await fetchProjectsTasks(project.id)"
                @restart = "tasks = await fetchProjectsTasks(project.id)"
            >
                <div class="row project-header mx-0 px-0">
                    <div class="col-sm-1"></div>
                    <p class="h2 col-sm-9" x-text="project.name"></p>
                    <div class="col-sm-2"></div>
                </div>

                <div class="row mx-0 px-1 bg-light-subtle">
                    <form
                        class="mb-0"
                        method="POST" 
                        x-bind:action="'api/projects/'+project.id+'/tasks/create'" 
                        @submit.prevent="
                            response = await makeXMLRequest(event);
                            response.addEventListener('readystatechange', function () {
                                if (this.readyState == 4 && this.status==200){
                                    $dispatch('restart')
                                }
                            });
                            
                        "
                    >
                    <div 
                        class=" d-flex justify-content-center p-0 m-auto input-group" >
                    <div class="col-sm-1">
                    </div>
                        <input 
                            class="col"
                            type="text" 
                            name="description" 
                            placeholder="Start typing here to create a task" 
                            pattern="^.{0,1000}$"
                        >
                        <button class="btn btn-success col-sm-2" type='submit'>Add Task</button>
                    </div>
                    </form>
                </div>
                    
                <div class="row bg-white rounded-bottom-5 mx-0 px-0">
                    <template x-for="task in tasks" >
                        <div class = "row mx-0 px-0 " x-data = "{checkbox_id: 'p'+project.id+'.t'+task.id, open: false }">
                            <div class = "d-flex col-1 text-start border-end border-top border-secondary ">
                                <input class="justify-content-center my-auto mx-auto col" type="checkbox" name="" x-bind:id="checkbox_id">
                            </div>
                            <div class = "d-flex col text-start border-start border-end border-top border-secondary">
                                <template x-if="open==false">
                                    <label x-bind:for="checkbox_id" x-text="task.description"></label>
                                </template>
                                <template x-if="open==true">
                                        <form
                                            method="POST" 
                                            x-bind:action="`api/projects/${project.id}/tasks/${task.id}/edit`" 
                                            @submit.prevent="
                                                response = makeXMLRequest(event);
                                                response.addEventListener('readystatechange', function () {
                                                    if (this.readyState == 4 && this.status==200){
                                                        $dispatch('restart')
                                                    }
                                                });
                                            "
                                        >
                                        <div class="form-group d-grid justify-content-center" x-data="{description: task.description, date: task.expire_date}">
                                            <div class = "row">
                                                    <div class = "col"> Description</div>
                                            </div>
                                            <textarea class=" row  w-100% form-control h-auto" type="text" name="description"  x-model="description"></textarea>
                                            <div class = "row my-1">
                                                <div class = "col"> Expire Date</div>
                                            </div>
                                            <input class = "row mx-1 h-auto form-control h-auto" type="datetime-local" name="expire_date" x-model="task.expire_date">
                                            <div class = "row my-1 mx-0 px-0">
                                                <button  class="btn btn-primary" type="submit"> Edit Task </button>
                                            </div>
                                        </div>
                                    </form>
                                </template>
                            </div>
                            <div class = "col-md-2 col-xs-3 d-flex justify-content-center border-top border-secondary" >
                                <template x-if="open==false">
                                    <button class='btn m-0 p-o'>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-expand" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10"/>
                                        </svg>
                                    </button>
                                </template>
                                <button  class='btn'
                                    @click="
                                        open = !open; 
                                    " 
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                                    </svg>
                                </button>
                                <template x-if="open==false">
                                    <button class='btn'>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                        </svg>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>


            </div>
        </template>
        </div>
        <div 
            class="d-flex justify-content-center"
            x-data="{ open: false, t_display: '', t_opened:'Add TODO List', t_closed: 'Close' }"
            x-init = "t_display = t_opened"
        >
        <button 
            class="btn btn-primary mx-2"
            @click="
                open = !open; 
                if(open){t_display = t_closed}else{t_display = t_opened};
            " 
            x-text="t_display"
        ></button>
        <template x-if="open==true">
                <div class = "d-flex ">
                    <form
                        method="POST" 
                        x-bind:action="'api/projects/create'" 
                        @submit.prevent="
                            response = makeXMLRequest(event);
                            response.addEventListener('readystatechange', function () {
                                if (this.readyState == 4 && this.status==200){
                                    $dispatch('restart')
                                }
                            });
                        "
                    >
                        <div class = "row">
                                <div class = "col"> Name</div>
                                <div class = "col"> Expire Date (optional)</div>
                        </div>
                        <div class = "row justify-content-center">
                            <div class = "col">
                                <input type="text" name="name" placeholder="PlaceHorlder">
                            </div>
                            <div class = "col">
                                <input type="datetime-local" name="expire_date">
                            </div>
                        </div>
                        <div class = "justify-content-center row mx-0 px-0">
                            <button  class="btn btn-primary" type="submit" x-text="t_opened"> </button>
                        </div>
                    </form>
                </div>
            </template>
        </div>
    </div>
    </body>
</html>