{% load static %}
<html>
    <head>
        <link href={% static "styles.css"%} rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script type="module" src={% static "listeners.js"%}></script>
        <script type="module" src={% static "tasks.js"%}></script>
        <script type="module" src={% static "xml_requests.js"%}></script>
    </head>
    <body  class="background">
    <div x-data="{projects: []}" @restart  = "projects = await (await fetch('/api/projects/')).json()">
        <div  id="main"
            x-init="projects = await (await fetch('/api/projects/')).json()"
        >
        <template x-for="project in projects">
            <div class="todo centered"
                x-data="{  key: 0, tasks: [] }"
                x-init="tasks = await fetchProjectsTasks(project.id)"
                @restart = "tasks = await fetchProjectsTasks(project.id)"
            >
                <div>
                    <p class="h2" x-text="project.name"></p>
                    <form
                        method="POST" 
                        x-bind:action="'api/projects/'+project.id+'/tasks/create'" 
                        @submit.prevent="
                            response = await makeXMLRequest(event);
                            response.addEventListener('readystatechange', function () {
                                if (this.readyState == 4 && this.status==200){
                                    $dispatch('restart')
                                }
                            });
                            
                        "
                    >
                        <input 
                            type="text" 
                            name="description" 
                            placeholder="Start typing here to create a task" 
                            pattern="^.{0,1000}$"
                        >
                        <button class="btn btn-success" type='submit'>Add Task</button>
                    </form>
                </div>
                    
                <table>
                <template x-for="task in tasks" >
                    <tr x-data = "{checkbox_id: 'p'+project.id+'.t'+task.id}">
                        <td>
                            <input type="checkbox" name="" x-bind:id="checkbox_id">
                        </td>
                        <td>
                            <label x-bind:for="checkbox_id" x-text="task.description"></label>
                        </td>
                        <td>
                            <button>Move</button>
                            <button>Edit</button>
                            <button>Delete</button>
                        </td>
                    </tr>
                </template>
                
                </table>


            </div>
        </template>
        </div>
        <div 
            class="centered"
            x-data="{ open: false, t_display: '', t_opened:'Add TODO List', t_closed: 'Close' }"
            x-init = "t_display = t_opened"
        >
        <button 
            class="btn btn-primary"
            @click="
                open = !open; 
                if(open){t_display = t_closed}else{t_display = t_opened};
            " 
            x-text="t_display"
        ></button>
        <template x-if="open==true">
                <div class="row">
                    <form
                        method="POST" 
                        x-bind:action="'api/projects/create'" 
                        @submit.prevent="
                            response = makeXMLRequest(event);
                            response.addEventListener('readystatechange', function () {
                                if (this.readyState == 4 && this.status==200){
                                    $dispatch('restart')
                                }
                            });
                        "
                    >
                        <div class = "row">
                                <div class = "col"> Name</div>
                                <div class = "col"> Expiration Date (optional)</div>
                        </div>
                        <div class = "row">
                            <div class = "col">
                                <input type="text" name="name" placeholder="PlaceHorlder">
                            </div>
                            <div class = "col">
                                <input type="datetime-local" name="expire_date">
                            </div>
                        </div>
                        <div class = "col">
                            <button  class="btn btn-primary" type="submit" x-text="t_opened"> </button>
                        </div>
                    </form>
                </div>
            </template>
        </div>
    </div>
    </body>
</html>